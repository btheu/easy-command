<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Easy Command</title>
	
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

</head>
<body>


<div id="app">

<div class="container theme-showcase">

	<div class="page-header">
		<h1>Easy Command</h1>
	</div>

	<command-input></command-input>
	
	<command-list></command-list>

</div>

<!-- app -->
</div>

<script type="text/template" id="modal-command-consult">
<modal @close="$emit('close')">

<div slot="title">
{{ command }}
</div>

<div slot="body">
   <div v-for="item in messages" class="row">
		<div class="col-md-12">
				{{ item }}
		</div>
   </div>
</div>

<div slot="footer">
</div>

</modal>

</script>

<script type="text/template" id="modal">
<div class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" @click="$emit('close')"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">
          <slot name="title">
            Modal title
          </slot>
		</h4>
      </div>
      <div class="modal-body">
        <slot name="body">
          <p>One fine body&hellip;</p>
        </slot>
      </div>
      <div class="modal-footer">
        <slot name="footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </slot>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</script>

<style>
.modal {
	display: block;
}
</style>

<script type="text/template" id="command-input">
	<div class="row">

		<div class="col-md-12">
			<p>
			<input type="text" v-model="command" v-on:keyup.enter="submit" class="form-control" placeholder="your command">
			</p>
		</div>

	</div>
</script>

<script type="text/template" id="command-list">

<div>

	<div class="row">
		<div class="col-md-12">

			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Command list</h3>
				</div>
				<div class="panel-body">
					<div v-for="item in commands" class="row">
						<div class="col-xs-2">
							{{item.state}}
						</div>
						<div class="col-xs-6">
							{{item.command}}
						</div>
						<div class="col-xs-1">
							<button v-if="item.state == 'running'" v-on:click="consult(item)" class="btn btn-sm btn-link">Consult</button>
						</div>
						<div class="col-xs-1">
							<button v-if="item.state == 'running'" v-on:click="kill(item)" class="btn btn-sm btn-link">Kill</button>
						</div>
<!--
						<div class="col-xs-1">
							<button v-if="item.state != 'running'" v-on:click="replay(item)" class="btn btn-sm btn-link">Replay</button>
						</div>-->
					</div>
				</div>
			</div>

		</div>
	</div>

	<modal-command-consult :command="commandConsult" v-if="showModal" @close="showModal = false"></modal-command-consult>

<div>

</script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://unpkg.com/vue"></script>
<script src="https://cdn.jsdelivr.net/vue.resource/1.3.1/vue-resource.min.js"></script>

<script type="text/javascript">

var wsProtocol = location.protocol == 'http:' ? 'ws:' : 'wss:';

Vue.component('modal-command-consult', {
	template: '#modal-command-consult',
	props: ['command'],
	data : function(){
		return {
			webSocket: null,
			messages : []
		}
	},
	mounted : function(){
		var self = this;
		this.webSocket = new WebSocket(wsProtocol + "//" + location.hostname + ":" + location.port + "/command?command="+encodeURIComponent(this.command));
		this.webSocket.onmessage = function (msg) {
			self.messages.push(JSON.parse(msg.data).message);
		};
		//this.webSocket.onclose = function () { alert("WebSocket Command Modal connection closed") }; 
	},
	beforeDestroy : function(){
		this.webSocket.close();
	},
	methods : {

	}
})

Vue.component('modal', {
	template: '#modal',
	data : function(){
		return {
		}
	},
	methods : {

	}
})
Vue.component('command-input', {
	template: '#command-input',
	data : function(){
		return {
			command: null
		}
	},
	methods : {
		submit: function(){
			this.$http.post( '/command?command='+this.command );
		}
	}
})
Vue.component('command-list', {
  template: '#command-list',
  data : function(){
	  return {
		  commands: [],
		  commandConsult: null,
		  webSocket: null,
		  showModal: false,
		  items:[{
			  id:1
		  },{
			  id:2
		  }]
	  }
  },
  created : function(){
	  this.$http.get('/command/list/').then(response => {

	    // get body data
	    this.commands = response.body.commands;
	  })
	  var self = this;
	  this.webSocket = new WebSocket(wsProtocol + "//" + location.hostname + ":" + location.port + "/command/list");
	  this.webSocket.onmessage = function (msg) {
		  self.commands = JSON.parse(msg.data).commands;
	  };
	  //this.webSocket.onclose = function () { alert("WebSocket Command List connection closed") }; 
  },
  beforeDestroy : function(){
	  this.webSocket.close();
  },
  methods : {
	  consult: function(item){
		  this.commandConsult = item.command;
		  this.showModal = true;
	  },
      kill: function(item){
    	  this.$http.post( '/command/kill?command='+item.command );
	  },
      replay: function(item){
    	  this.$http.post( '/command?command='+item.command );
	  }
  }
})

var app = new Vue({
  el: '#app',
  data: {
    showModal: false
  }
})

</script>

</body>
</html>